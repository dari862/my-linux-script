#!/usr/bin/env bash
set -euo pipefail

op__="${1-}"
op2__="${2-}"
tldr_dir="$HOME/.local/share/tldr"

update_tldr_(){
	cd "${tldr_dir}" &> /dev/null && git pull 2> /dev/null
}

run_my_tldr_(){

	[ ! -d "${tldr_dir}" ] && git clone https://github.com/tldr-pages/tldr "${tldr_dir}"
	[ ! -d "${tldr_dir}/.git" ] && rm -rdf "${tldr_dir}" && git clone https://github.com/tldr-pages/tldr "${tldr_dir}"
	
	if [ "$(stat -c %y "${tldr_dir}/pages" 2>/dev/null | cut -d' ' -f1 | cut -d'-' -f1-2)" != "$(date '+%Y-%m')" ]
	then
		update_tldr_
	fi
	
	[ ! -z "$(cd "${tldr_dir}" &> /dev/null && git checkout | sed '$ d')" ] && git checkout .

	command_2_find_="$(find "${tldr_dir}/pages/" -name ${op2__}.md)"
	
	if [ -z "${command_2_find_}" ]
	then
		echo "no tldr entry for ${op2__}" 
		exit 1
	fi
	grep_this="common|linux"
	command_2_find_="$(echo "${command_2_find_}" | grep -E "$grep_this")"
	cat ${command_2_find_}
}

help()
{
	echo "help"
}

main()
{
case $op__ in
	-c|--cheat)
		curl -s "cheat.sh/$op2__"
	;;
	-t|--tldr)
		run_my_tldr_
	;;
	-tu|--tldr-update)
		update_tldr_
	;;
	*)
		help
	;;
esac
}

main
